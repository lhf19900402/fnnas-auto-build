name: Kernel Factory
on:
  workflow_dispatch:

jobs:
  check-and-build:
    runs-on: ubuntu-latest
    steps:
      - name: Install Host Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-user-static binfmt-support curl debootstrap

      - name: Check Version Status
        id: check_ver
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. è·å– Debian å®˜æ–¹ä»“åº“ç›®å‰çš„æœ€æ–°ç‰ˆæœ¬å·
          INDEX_URL="http://ftp.debian.org/debian/dists/bookworm/main/binary-arm64/Packages.gz"
          FULL_NAME=$(curl -s "$INDEX_URL" | zgrep "Package: linux-image-6.1.0-" | awk '{print $2}' | grep -vE "rt|dbg|unsigned|cloud" | sort -V | tail -n 1)
          KVER=$(echo $FULL_NAME | sed 's/linux-image-//;s/-arm64//')
          echo "KVER=$KVER" >> $GITHUB_ENV
          
          # 2. æ£€æŸ¥ GitHub Release ä¸­æ˜¯å¦å·²å­˜åœ¨è¯¥ç‰ˆæœ¬çš„ initrd
          # æˆ‘ä»¬æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨åä¸º initrd.img-6.1.0-xx-arm64 çš„æ–‡ä»¶
          RELEASE_TAG="kernel-assets"
          EXISTS=$(gh release view "$RELEASE_TAG" --json assets -q ".assets[] | select(.name == \"initrd.img-6.1.0-$KVER-arm64\") | .name" || echo "")

          if [ -n "$EXISTS" ]; then
            echo "âœ… ç‰ˆæœ¬ 6.1.0-$KVER å·²å­˜åœ¨äº Release ä¸­ï¼Œæ— éœ€é‡å¤åˆ¶ä½œã€‚"
            echo "SKIP_BUILD=true" >> $GITHUB_ENV
          else
            echo "ğŸš€ å‘ç°æ–°ç‰ˆæœ¬ 6.1.0-$KVERï¼Œå‡†å¤‡å¼€å§‹æ„å»º..."
            echo "SKIP_BUILD=false" >> $GITHUB_ENV
          fi

      - name: Build ARM64 Environment and Generate Kernel
        if: env.SKIP_BUILD == 'false'
        run: |
          echo "ğŸ—ï¸ æ­£åœ¨æ„å»ºæœ€å°åŒ– ARM64 ç¯å¢ƒ (ç‰ˆæœ¬: 6.1.0-${{ env.KVER }})..."
          sudo debootstrap --arch=arm64 --variant=minbase bookworm chroot http://ftp.debian.org/debian/
          
          sudo cp /usr/bin/qemu-aarch64-static chroot/usr/bin/
          sudo mount --bind /dev chroot/dev
          sudo mount --bind /proc chroot/proc
          sudo mount --bind /sys chroot/sys

          echo "â³ æ­£åœ¨ Chroot ç¯å¢ƒå†…ç”Ÿæˆå†…æ ¸ä¸ Initrd (zstd)..."
          sudo chroot chroot /bin/bash -c "
            apt-get update
            apt-get install -y initramfs-tools kmod --no-install-recommends
            apt-get install -y linux-image-6.1.0-${{ env.KVER }}-arm64
            sed -i 's/COMPRESS=.*/COMPRESS=zstd/g' /etc/initramfs-tools/initramfs.conf
            update-initramfs -c -k 6.1.0-${{ env.KVER }}-arm64
          "

          cp chroot/boot/vmlinuz-6.1.0-${{ env.KVER }}-arm64 ./vmlinuz-6.1.0-${{ env.KVER }}-arm64
          cp chroot/boot/initrd.img-6.1.0-${{ env.KVER }}-arm64 ./initrd.img-6.1.0-${{ env.KVER }}-arm64
          
          sudo umount chroot/dev chroot/proc chroot/sys

      - name: Upload to Release
        if: env.SKIP_BUILD == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: kernel-assets
          files: |
            vmlinuz-6.1.0-${{ env.KVER }}-arm64
            initrd.img-6.1.0-${{ env.KVER }}-arm64
          body: "Debian 6.1 æ ‡å‡†å†…æ ¸ç»„ä»¶åº“ (zstd å‹ç¼©ç‰ˆ - è‡ªåŠ¨åŒ–å·¥å‚äº§å‡º)"
          append_body: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Final Summary
        run: |
          if [ "${{ env.SKIP_BUILD }}" == "true" ]; then
            echo "--------------------------------------------------"
            echo "  ğŸ ä»»åŠ¡ç»“æŸ: å·²ç»æ˜¯æœ€æ–°ç‰ˆæœ¬ (${{ env.KVER }})ï¼Œæœªæ‰§è¡Œæ„å»ºã€‚"
            echo "--------------------------------------------------"
          else
            echo "--------------------------------------------------"
            echo "  ğŸ‰ ä»»åŠ¡ç»“æŸ: æ–°ç‰ˆæœ¬ (${{ env.KVER }}) æ„å»ºå¹¶ä¸Šä¼ æˆåŠŸï¼"
            echo "--------------------------------------------------"
          fi
