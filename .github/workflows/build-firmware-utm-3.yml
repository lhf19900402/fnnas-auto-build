name: Patch fNOS Image for UTM
on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest 
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fdisk xz-utils grep sed tar kmod zstd curl
          echo "âœ… åŸºç¡€å·¥å…·å®‰è£…å®Œæˆ"

      - name: Get Latest Release Info and Download
        id: get_info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="ophub/fnnas"
          TAG="fnnas_base_image"
          LATEST_ASSET=$(gh release view "$TAG" -R "$REPO" --json assets \
            -q '.assets[] | select(.name | endswith(".img.xz")) | .name' | \
            sort -V | tail -n 1)
          
          VERSION=$(echo "$LATEST_ASSET" | grep -oP '\d+(?=\.img\.xz)')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "SOURCE_FILE=$LATEST_ASSET" >> $GITHUB_ENV
          gh release download "$TAG" -R "$REPO" -p "$LATEST_ASSET" --clobber

      - name: Decompress and Inject Kernel (Speed Mode)
        run: |
          echo "ğŸ“¦ æ­£åœ¨è§£å‹æ–°é•œåƒ..."
          unxz -v -c "${{ env.SOURCE_FILE }}" > source.img
          
          sudo losetup -D
          LOOP_DEV=$(sudo losetup -Pf --show source.img)
          
          echo "ğŸ’¾ æ­£åœ¨æå– Rootfs..."
          mkdir -p mnt_new
          sudo dd if="${LOOP_DEV}p2" of=rootfs.img bs=1M status=none
          sudo mount rootfs.img mnt_new

          # --- æ ¸å¿ƒæ”¹è¿›ï¼šç¦»çº¿æ³¨å…¥é€»è¾‘ ---
          echo "ğŸŒ ä¸‹è½½å®˜æ–¹ Debian ARM64 å†…æ ¸åŒ…..."
          # ä½¿ç”¨ Debian 12 ç¨³å®šçš„ 6.1 ç³»åˆ—å†…æ ¸
          KERNEL_URL="http://ftp.debian.org/debian/pool/main/l/linux/linux-image-6.1.0-28-arm64_6.1.119-1_arm64.deb"
          curl -LO $KERNEL_URL
          
          echo "ğŸ› ï¸ æ­£åœ¨è§£å‹å¹¶æ³¨å…¥é©±åŠ¨æ¨¡å—..."
          mkdir -p kextract
          dpkg-deb -x *.deb kextract/
          
          # æ³¨å…¥æ¨¡å—åˆ°é•œåƒï¼Œæå–å†…æ ¸å’Œ initrd åˆ°å¤–éƒ¨
          sudo cp -r kextract/lib/modules/* mnt_new/lib/modules/
          cp kextract/boot/vmlinuz-* ./vmlinuz-standard
          cp kextract/boot/initrd.img-* ./initrd-standard
          
          # é‡Šæ”¾ç©ºé—´ï¼šç§»é™¤åŸé•œåƒä¸­ä¸åŒ¹é…çš„é©±åŠ¨ç›®å½•
          sudo rm -rf mnt_new/lib/modules/6.12.41-trim
          # ----------------------------

          echo "ğŸ› ï¸ åº”ç”¨è™šæ‹Ÿæœºé€‚é…ä¿®æ­£..."
          sudo sed -i 's/^.*\/boot/#&/' mnt_new/etc/fstab
          sudo sed -i 's/^UUID=[^ ]*/\/dev\/vda/' mnt_new/etc/fstab
          sudo sed -i 's/^\/dev\/mmcblk0p2/\/dev\/vda/' mnt_new/etc/fstab
          
          # ç§»é™¤å†²çªæœåŠ¡
          sudo rm -f mnt_new/etc/systemd/system/multi-user.target.wants/trim_miniscreen.service
          sudo rm -f mnt_new/etc/systemd/system/multi-user.target.wants/trim_wayland.service

          echo "ğŸ§¹ æ¸…ç†å¸è½½..."
          sudo umount mnt_new
          sudo losetup -d $LOOP_DEV
          rm source.img
          rm -rf kextract *.deb
          echo "âœ… è¡¥ä¸å¤„ç†å®Œæˆ"

      - name: Final Packaging
        run: |
          PKG_DIR="fn_utm_${{ env.VERSION }}"
          mkdir -p "$PKG_DIR"
          mv rootfs.img vmlinuz-standard initrd-standard "$PKG_DIR/"
          
          cat << EOF > "$PKG_DIR/README.md"
          # fNOS UTM ARM64 (Extreme Speed Build)
          
          1. ç£ç›˜ (Drives): å¯¼å…¥ rootfs.img (æ¥å£é€‰ VirtIO)
          2. å†…æ ¸ (Kernel): vmlinuz-standard
          3. Initrd: initrd-standard
          4. å¯åŠ¨å‚æ•° (Arguments): "root=/dev/vda rw console=tty0 console=ttyAMA0 rootwait"
          
          æ³¨æ„ï¼šUTM ç•Œé¢æ˜¾ç¤ºçš„ 64GB å­˜å‚¨ç©ºé—´ä¸ºè™šè®¾ï¼Œè¯·è‡ªè¡Œæ·»åŠ ç¬¬äºŒå— VirtIO ç£ç›˜ä½œä¸ºæ•°æ®ç›˜ã€‚
          EOF

          tar -cvf - "$PKG_DIR" | xz -z -T0 -v > "${PKG_DIR}.tar.xz"
          echo "FINAL_PKG_NAME=${PKG_DIR}.tar.xz" >> $GITHUB_ENV

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: fnnas_utm
          name: fnnas_utm_${{ env.VERSION }}
          body: |
            fnOS UTM è™šæ‹Ÿæœºè¡¥ä¸ç‰ˆ (æé€Ÿæ³¨å…¥ç‰ˆ)
            å†…æ ¸ç‰ˆæœ¬: Debian 6.1.0-28-arm64
          files: ${{ env.FINAL_PKG_NAME }}
          overwrite_files: true
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
