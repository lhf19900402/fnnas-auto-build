name: fNOS UTM Patcher (Strict Extraction)
on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fdisk xz-utils grep sed tar kmod zstd curl file qemu-user-static
          echo "âœ… åŸºç¡€å·¥å…·å®‰è£…å®Œæˆ"

      - name: Get Latest Release Info and Download
        id: get_info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="ophub/fnnas"
          TAG="fnnas_base_image"
          LATEST_ASSET=$(gh release view "$TAG" -R "$REPO" --json assets \
            -q '.assets[] | select(.name | endswith(".img.xz")) | .name' | \
            sort -V | tail -n 1)
          
          VERSION=$(echo "$LATEST_ASSET" | grep -oP '\d+(?=\.img\.xz)')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "SOURCE_FILE=$LATEST_ASSET" >> $GITHUB_ENV
          gh release download "$TAG" -R "$REPO" -p "$LATEST_ASSET" --clobber

      - name: Decompress and Inject Kernel
        run: |
          # --- ä¸¥æ ¼ä¿ç•™ä½ çš„åŽŸè§£åŽ‹é€»è¾‘ ---
          echo "ðŸ“¦ æ­£åœ¨è§£åŽ‹é•œåƒ..."
          unxz -v -c "${{ env.SOURCE_FILE }}" > source.img
          
          sudo losetup -D
          LOOP_DEV=$(sudo losetup -Pf --show source.img)
          
          echo "ðŸ’¾ æ­£åœ¨æŒ‰ç…§åŽŸé€»è¾‘æå–å¹¶æŒ‚è½½ Rootfs..."
          mkdir -p mnt_new
          # ä¸¥æ ¼ä¿ç•™ä½ åŽŸæ¥çš„ dd p2 é€»è¾‘
          sudo dd if="${LOOP_DEV}p2" of=rootfs.img bs=1M status=none
          sudo mount rootfs.img mnt_new

          # --- åŠ¨æ€æŠ“å–å†…æ ¸ (å¤–éƒ¨å®Œæˆ) ---
          INDEX_URL="http://ftp.debian.org/debian/dists/bookworm/main/binary-arm64/Packages.gz"
          RELATIVE_PATH=$(curl -s "$INDEX_URL" | zgrep -A 20 "Package: linux-image-6.1.0-.*-arm64$" | grep "Filename:" | head -n 1 | awk '{print $2}')
          KERNEL_URL="http://ftp.debian.org/debian/$RELATIVE_PATH"
          curl -fL -o mnt_new/kernel.deb "$KERNEL_URL"

          # --- ä½¿ç”¨éªŒè¯é€šè¿‡çš„ Chroot æ³¨å…¥é€»è¾‘ ---
          sudo mount --bind /dev mnt_new/dev
          sudo mount --bind /proc mnt_new/proc
          sudo mount --bind /sys mnt_new/sys
          sudo cp /usr/bin/qemu-aarch64-static mnt_new/usr/bin/

          echo "ðŸš€ æ­£åœ¨ Chroot å†…éƒ¨æ‰§è¡ŒåŽŸç”Ÿ dpkg å®‰è£…..."
          sudo chroot mnt_new /usr/bin/dpkg -i --force-all /kernel.deb

          # æå–å¼•å¯¼æ–‡ä»¶
          KVER=$(ls mnt_new/lib/modules/ | grep "6.1.0" | sort -V | tail -n 1)
          cp mnt_new/boot/vmlinuz-$KVER ./vmlinuz-standard
          cp mnt_new/boot/initrd.img-$KVER ./initrd-standard

          # --- ä¿®æ­£ä¸Žæ¸…ç† ---
          sudo rm -rf mnt_new/lib/modules/6.12.*-trim
          sudo sed -i 's/^.*\/boot/#&/' mnt_new/etc/fstab
          sudo sed -i 's/^\/dev\/mmcblk0p2/\/dev\/vda/' mnt_new/etc/fstab
          
          sudo umount -l mnt_new/dev mnt_new/proc mnt_new/sys
          sudo umount mnt_new
          sudo losetup -d $LOOP_DEV
          rm source.img mnt_new/kernel.deb
          echo "âœ… æ³¨å…¥å®Œæˆ"

      - name: Final Packaging
        run: |
          PKG_DIR="fn_utm_${{ env.VERSION }}"
          mkdir -p "$PKG_DIR"
          # ä¸¥æ ¼ä¿ç•™ä½ çš„åŽŸæ‰“åŒ…é€»è¾‘ï¼Œåªç§»åŠ¨ä½ è¦æ±‚çš„ä¸‰ä¸ªæ–‡ä»¶
          mv rootfs.img vmlinuz-standard initrd-standard "$PKG_DIR/"
          
          tar -cvf - "$PKG_DIR" | xz -z -T0 -v > "${PKG_DIR}.tar.xz"
          echo "FINAL_PKG_NAME=${PKG_DIR}.tar.xz" >> $GITHUB_ENV

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: fnnas_utm
          files: ${{ env.FINAL_PKG_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
