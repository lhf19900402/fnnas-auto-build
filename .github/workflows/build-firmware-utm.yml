name: Patch fNOS Image for UTM
on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fdisk xz-utils grep sed
          echo "âœ… åŸºç¡€ä¾èµ–åº“å®‰è£…å®Œæˆ"

      - name: Get Latest Release Info and Download
        id: get_info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="ophub/fnnas"
          TAG="fnnas_base_image"
          
          echo "ğŸ” æ­£åœ¨æœç´¢æœ€æ–°é™„ä»¶..."
          # è·å–æœ€æ–° .img.xz é™„ä»¶å
          LATEST_ASSET=$(gh release view "$TAG" -R "$REPO" --json assets \
            -q '.assets[] | select(.name | endswith(".img.xz")) | .name' | sort -V | tail -n 1)
          
          if [ -z "$LATEST_ASSET" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ° .img.xz é™„ä»¶"
            exit 1
          fi
          
          # æå–ç‰ˆæœ¬å· (ä¾‹å¦‚ä» allwinner_317.img.xz æå– 317)
          VERSION=$(echo "$LATEST_ASSET" | grep -oP '(?<=_)\d+(?=\.img\.xz)' || echo "unknown")
          
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "SOURCE_FILE=$LATEST_ASSET" >> $GITHUB_ENV
          
          echo "ğŸ“¥ å¼€å§‹ä¸‹è½½: $LATEST_ASSET"
          gh release download "$TAG" -R "$REPO" -p "$LATEST_ASSET" --clobber

      - name: Decompress and Patch Image
        run: |
          echo "ğŸ“¦ æ­£åœ¨è§£å‹é•œåƒ (è¿™å¯èƒ½éœ€è¦ 1-2 åˆ†é’Ÿ)..."
          unxz -v -c "${{ env.SOURCE_FILE }}" > source.img
          rm "${{ env.SOURCE_FILE }}" # é‡Šæ”¾ç©ºé—´

          echo "ğŸ› ï¸ æ­£åœ¨å…³è” Loop è®¾å¤‡..."
          sudo losetup -D
          LOOP_DEV=$(sudo losetup -Pf --show source.img)
          
          mkdir -p mnt_p1 mnt_p2

          # 1. æŒ‚è½½ p1 æå–åŸå§‹å†…æ ¸
          echo "ğŸ“‚ æå–å†…æ ¸æ–‡ä»¶..."
          sudo mount "${LOOP_DEV}p1" mnt_p1
          KERNEL_PATH=$(sudo find mnt_p1 -name "vmlinuz-*" ! -name "*.old" | sort -V | tail -n 1)
          INITRD_PATH=$(sudo find mnt_p1 -name "initrd.img-*" ! -name "*.old" | sort -V | tail -n 1)
          
          RAW_KERNEL=$(basename "$KERNEL_PATH")
          RAW_INITRD=$(basename "$INITRD_PATH")
          cp "$KERNEL_PATH" ./"$RAW_KERNEL"
          cp "$INITRD_PATH" ./"$RAW_INITRD"
          
          echo "RAW_KERNEL=$RAW_KERNEL" >> $GITHUB_ENV
          echo "RAW_INITRD=$RAW_INITRD" >> $GITHUB_ENV
          sudo umount mnt_p1

          # 2. æŒ‚è½½ p2 ä¿®æ”¹é…ç½®
          echo "âœï¸ ä¿®æ”¹ç³»ç»Ÿé…ç½® (fstab & services)..."
          sudo mount "${LOOP_DEV}p2" mnt_p2
          sudo sed -i 's/^.*\/boot/#&/' mnt_p2/etc/fstab
          sudo sed -i 's/^\/dev\/mmcblk0p2/\/dev\/vdb2/' mnt_p2/etc/fstab
          sudo rm -f mnt_p2/etc/systemd/system/multi-user.target.wants/trim_miniscreen.service
          sudo rm -f mnt_p2/etc/systemd/system/multi-user.target.wants/trim_wayland.service
          
          sudo umount mnt_p2
          sudo losetup -D
          echo "âœ… é•œåƒæ‰‹æœ¯å®Œæˆ"

      - name: Create README for UTM
        run: |
          echo "ğŸ“ ç”Ÿæˆä½¿ç”¨è¯´æ˜..."
          cat << EOF > README.md
          # fNOS UTM è™šæ‹Ÿæœºä½¿ç”¨è¯´æ˜ (v${VERSION})

          æ­¤é™„ä»¶ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆï¼Œä¸“é—¨ç”¨äº UTM è™šæ‹Ÿæœºçš„ä¸€é”®å¯åŠ¨ã€‚

          ## ğŸ“„ æ–‡ä»¶æ¸…å•
          1. **é•œåƒæ–‡ä»¶**: fn_utm_${VERSION}.img.xz (ä½¿ç”¨å‰è¯·å…ˆè§£å‹)
          2. **å†…æ ¸æ–‡ä»¶**: ${RAW_KERNEL}
          3. **Initrdæ–‡ä»¶**: ${RAW_INITRD}

          ## ğŸš€ UTM é…ç½®æŒ‡å—
          1. **é©±åŠ¨å™¨ (Drive)**: å¯¼å…¥è§£å‹åçš„é•œåƒï¼Œæ¥å£é€‰æ‹© **VirtIO**ã€‚
          2. **é«˜çº§ (Advanced)**:
             - å‹¾é€‰ **"ä½¿ç”¨æœ¬åœ°å†…æ ¸/initrd"**ã€‚
             - **External Kernel**: é€‰æ‹© \`${RAW_KERNEL}\`ã€‚
             - **Initrd**: é€‰æ‹© \`${RAW_INITRD}\`ã€‚
          3. **å¯åŠ¨å‚æ•° (Arguments)**:
             - åœ¨ UTM å‚æ•°æ¡†ä¸­å¡«å…¥ä»¥ä¸‹å¸¦å¼•å·çš„å®Œæ•´å†…å®¹ï¼š
               \`\`\`text
               "root=/dev/vdb2 rw console=tty0 console=ttyAMA0 earlycon"
               \`\`\`

          ---
          *Build Date: $(date)*
          EOF

      - name: Compress Final Image
        run: |
          FINAL_NAME="fn_utm_${VERSION}.img.xz"
          echo "ğŸ—œï¸ é‡æ–°æ‰“åŒ…é•œåƒ (xz -T0)..."
          xz -z -T0 -v -c source.img > "$FINAL_NAME"
          echo "FINAL_IMG_NAME=$FINAL_NAME" >> $GITHUB_ENV

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fnos-utm-v${{ env.VERSION }}
          path: |
            ${{ env.FINAL_IMG_NAME }}
            ${{ env.RAW_KERNEL }}
            ${{ env.RAW_INITRD }}
            README.md
