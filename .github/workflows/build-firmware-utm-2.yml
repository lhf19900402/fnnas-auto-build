name: Patch fNOS Image for UTM (Standard Kernel)
on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fdisk xz-utils grep sed tar kmod zstd
          echo "âœ… ä¾èµ–åº“å®‰è£…å®Œæˆ"

      - name: Get Latest Release Info and Download
        id: get_info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="ophub/fnnas"
          TAG="fnnas_base_image"
          LATEST_ASSET=$(gh release view "$TAG" -R "$REPO" --json assets \
            -q '.assets[] | select(.name | endswith(".img.xz")) | .name' | \
            sed -E 's/.*_([0-9]+)\.img\.xz/\1 &/' | \
            sort -n | tail -n 1 | cut -d' ' -f2-)
          
          echo "VERSION=$(echo "$LATEST_ASSET" | grep -oP '(?<=_)\d+(?=\.img\.xz)')" >> $GITHUB_ENV
          echo "SOURCE_FILE=$LATEST_ASSET" >> $GITHUB_ENV
          gh release download "$TAG" -R "$REPO" -p "$LATEST_ASSET" --clobber

      - name: Decompress and Patch Image
        run: |
          unxz -v -c "${{ env.SOURCE_FILE }}" > source.img
          LOOP_DEV=$(sudo losetup -Pf --show source.img)
          mkdir -p mnt_new
          
          # æå–å¹¶æŒ‚è½½ Rootfs
          sudo dd if="${LOOP_DEV}p2" of=rootfs.img bs=1M
          sudo mount rootfs.img mnt_new

          # --- å…³é”®æ­¥éª¤ï¼šç©ºé—´ä¸ç¯å¢ƒå‡†å¤‡ ---
          # 1. åˆ æ‰æ—§é©±åŠ¨ç›®å½•è…¾ç©ºé—´ (å…³é”®ï¼šé‡Šæ”¾çº¦ 400MB)
          sudo rm -rf mnt_new/lib/modules/6.12.41-trim
          
          # 2. å‡†å¤‡ chroot ç¯å¢ƒ
          sudo mount --bind /dev mnt_new/dev
          sudo mount --bind /proc mnt_new/proc
          sudo mount --bind /sys mnt_new/sys
          sudo cp /etc/resolv.conf mnt_new/etc/resolv.conf # è§£å†³ç½‘ç»œè§£æ

          # 3. å®‰è£…æ ‡å‡†å†…æ ¸
          sudo chroot mnt_new /bin/bash -c "
            apt-get update
            apt-get install -y linux-image-arm64
            apt-get clean
          "

          # 4. æå–å®‰è£…å¥½çš„æ ‡å‡†å†…æ ¸å’Œå¼•å¯¼æ–‡ä»¶
          cp mnt_new/boot/vmlinuz-*-arm64 ./vmlinuz-standard
          cp mnt_new/boot/initrd.img-*-arm64 ./initrd-standard

          # 5. é€‚é… UTM (fstab)
          sudo sed -i 's/^.*\/boot/#&/' mnt_new/etc/fstab
          sudo sed -i 's/^UUID=[^ ]*/\/dev\/vda/' mnt_new/etc/fstab
          sudo sed -i 's/^\/dev\/mmcblk0p2/\/dev\/vda/' mnt_new/etc/fstab
          
          # 6. å¸è½½
          sudo umount mnt_new/dev mnt_new/proc mnt_new/sys
          sudo umount mnt_new
          sudo losetup -d $LOOP_DEV

      - name: Create README
        run: |
          cat << EOF > README.md
          # fNOS UTM ARM64 (Standard Kernel Edition)
          
          æ­¤ç‰ˆæœ¬å·²æ³¨å…¥ Debian æ ‡å‡†å†…æ ¸ï¼Œæ”¯æŒ NFS æœåŠ¡ã€‚
          
          ## ğŸš€ UTM é…ç½®æŒ‡å—
          1. **é©±åŠ¨å™¨**: å¯¼å…¥ \`rootfs.img\` (VirtIO æ¥å£)ã€‚
          2. **å¤–éƒ¨å†…æ ¸**: ä½¿ç”¨ \`vmlinuz-standard\`ã€‚
          3. **Initrd**: ä½¿ç”¨ \`initrd-standard\`ã€‚
          4. **å¯åŠ¨å‚æ•°**: "root=/dev/vda rw console=tty0 console=ttyAMA0 rootwait"
          EOF

      - name: Final Packaging
        run: |
          PKG_DIR="fn_utm_${{ env.VERSION }}"
          mkdir -p "$PKG_DIR"
          mv rootfs.img vmlinuz-standard initrd-standard README.md "$PKG_DIR/"
          tar -cvf - "$PKG_DIR" | xz -z -T0 -v > "${PKG_DIR}.tar.xz"
          echo "FINAL_PKG_NAME=${PKG_DIR}.tar.xz" >> $GITHUB_ENV

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: fnnas_utm
          name: fnnas_utm_${{ env.VERSION }}
          body: |
            ## é£ç‰› OS (FnOS) UTM è™šæ‹Ÿæœºé€‚é…ç‰ˆ
            
            **ğŸ”¥ æœ¬ç‰ˆæœ¬ç‰¹æ€§ï¼š**
            - **æ ‡å‡†å†…æ ¸æ³¨å…¥**ï¼šé›†æˆ Debian å®˜æ–¹ `6.1.0-xx-arm64` å†…æ ¸ã€‚
            
            **ğŸ› ï¸ UTM å¯¼å…¥è¯´æ˜ï¼š**
            1. **ç³»ç»Ÿç±»å‹**: Linux / ARM64
            2. **å†…æ ¸ (Kernel)**: é€‰æ‹©è§£å‹åçš„ `vmlinuz-standard`
            3. **åˆå§‹åŒ–é•œåƒ (Initrd)**: é€‰æ‹©è§£å‹åçš„ `initrd-standard`
            4. **ç£ç›˜ (Drive)**: å¯¼å…¥ `rootfs.img` (æ¥å£é€‰æ‹© **VirtIO**)
            5. **å¯åŠ¨å‚æ•° (Arguments)**: 
               "root=/dev/vda rw console=tty0 console=ttyAMA0 rootwait"
            
            > æ³¨æ„ï¼šç³»ç»Ÿç›˜ç©ºé—´æœ‰é™ (3.1G)ï¼Œè¯·åŠ¡å¿…æŒ‚è½½é¢å¤–çš„è™šæ‹Ÿç£ç›˜ä½œä¸ºæ•°æ®å­˜å‚¨ã€‚
          files: ${{ env.FINAL_PKG_NAME }}
          overwrite_files: true
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
