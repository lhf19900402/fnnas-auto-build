name: é•œåƒè¡¥ä¸å™¨
on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: å®‰è£…ä¾èµ–åº“
        run: |
          sudo apt-get update
          sudo apt-get install -y fdisk xz-utils grep sed tar kmod zstd
          echo "âœ… åŸºç¡€ä¾èµ–å®‰è£…å®Œæˆ"

      - name: è·å–æœ€æ–°é£ç‰›é•œåƒ
        id: get_info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="ophub/fnnas"
          TAG="fnnas_base_image"
          LATEST_ASSET=$(gh release view "$TAG" -R "$REPO" --json assets \
            -q '.assets[] | select(.name | endswith(".img.xz")) | .name' | \
            sed -E 's/.*_([0-9]+)\.img\.xz/\1 &/' | \
            sort -n | tail -n 1 | cut -d' ' -f2-)
          
          echo "VERSION=$(echo "$LATEST_ASSET" | grep -oP '(?<=_)\d+(?=\.img\.xz)')" >> $GITHUB_ENV
          echo "SOURCE_FILE=$LATEST_ASSET" >> $GITHUB_ENV
          gh release download "$TAG" -R "$REPO" -p "$LATEST_ASSET" --clobber
          echo "âœ… ä¸‹è½½é•œåƒå®Œæˆ: $LATEST_ASSET"

      - name: ä»å†…æ ¸å·¥å‚åŒæ­¥æˆå“
        id: sync_kernel
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # è‡ªåŠ¨è·å–å·¥å‚ Release ä¸­ç‰ˆæœ¬å·æœ€é«˜çš„æ–‡ä»¶
          RELEASE_TAG="kernel-assets"
          LATEST_VMLINUZ=$(gh release view "$RELEASE_TAG" --json assets -q ".assets[] | select(.name | startswith(\"vmlinuz-\")) | .name" | sort -V | tail -n 1)
          
          if [ -z "$LATEST_VMLINUZ" ]; then
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°å†…æ ¸æˆå“ï¼Œè¯·å…ˆè¿è¡Œå†…æ ¸å·¥å‚è„šæœ¬ã€‚"
            exit 1
          fi
          
          K_VER_FULL=$(echo $LATEST_VMLINUZ | sed 's/vmlinuz-//')
          echo "K_VER_FULL=$K_VER_FULL" >> $GITHUB_ENV
          
          # ä¸‹è½½å¯¹åº”çš„ vmlinuz å’Œ initrd
          gh release download "$RELEASE_TAG" -p "vmlinuz-$K_VER_FULL" --clobber
          gh release download "$RELEASE_TAG" -p "initrd.img-$K_VER_FULL" --clobber
          
          mv "vmlinuz-$K_VER_FULL" vmlinuz-standard
          mv "initrd.img-$K_VER_FULL" initrd-standard
          echo "âœ… å·²åŒæ­¥å†…æ ¸ç‰ˆæœ¬: $K_VER_FULL"

      - name: è§£å‹å¹¶ä¿®è¡¥é•œåƒ
        run: |
          echo "ğŸ“¦ æ­£åœ¨å¿«é€Ÿå¤„ç†é•œåƒ..."
          unxz -v -c "${{ env.SOURCE_FILE }}" > source.img
          
          sudo losetup -D
          LOOP_DEV=$(sudo losetup -Pf --show source.img)
          
          # 1. æŒ‚è½½ Rootfs
          mkdir -p mnt_new
          sudo dd if="${LOOP_DEV}p2" of=rootfs.img bs=1M status=none
          sudo mount rootfs.img mnt_new

          # 2. æ³¨å…¥å¯¹åº”ç‰ˆæœ¬çš„é©±åŠ¨æ¨¡å— (ç›´æ¥ä» Debian ä¸‹è½½ deb åŒ…æå–)
          INDEX_URL="http://ftp.debian.org/debian/dists/bookworm/main/binary-arm64/Packages.gz"
          DEB_PATH=$(curl -s "$INDEX_URL" | zgrep -A 20 "Package: linux-image-${{ env.K_VER_FULL }}$" | grep "Filename: " | awk '{print $2}' | head -n 1)
          curl -fL -o kernel.deb "http://ftp.debian.org/debian/$DEB_PATH"
          
          # æ¸…ç†æ—§æ¨¡å—ï¼Œæå–æ–°æ¨¡å—
          sudo rm -rf mnt_new/lib/modules/*
          sudo dpkg-deb -x kernel.deb mnt_new/
          echo "âœ… é©±åŠ¨æ¨¡å—æ³¨å…¥å®Œæˆ"

          # 3. åº”ç”¨è™šæ‹Ÿæœºé€‚é…ä¿®æ­£
          echo "ğŸ› ï¸ æ­£åœ¨åº”ç”¨è™šæ‹Ÿæœºé€‚é…è¡¥ä¸..."
          sudo sed -i 's/^.*\/boot/#&/' mnt_new/etc/fstab
          sudo sed -i 's/^UUID=[^ ]*/\/dev\/vda/' mnt_new/etc/fstab
          sudo sed -i 's/^\/dev\/mmcblk0p2/\/dev\/vda/' mnt_new/etc/fstab
          
          # ç§»é™¤å†²çªæœåŠ¡
          sudo rm -f mnt_new/etc/systemd/system/multi-user.target.wants/trim_miniscreen.service
          sudo rm -f mnt_new/etc/systemd/system/multi-user.target.wants/trim_wayland.service

          # 4. å¸è½½æ¸…ç†
          sudo umount mnt_new
          sudo losetup -d $LOOP_DEV
          rm source.img kernel.deb
          echo "âœ… è¡¥ä¸å¤„ç†å®Œæˆ"

      - name: æœ€ç»ˆæ‰“åŒ…
        run: |
          PKG_DIR="fn_utm_${{ env.VERSION }}"
          mkdir -p "$PKG_DIR"
          mv rootfs.img vmlinuz-standard initrd-standard "$PKG_DIR/"
          
          cat << EOF > "$PKG_DIR/è¯´æ˜.txt"
          # é£ç‰› OS UTM è™šæ‹Ÿæœºè¡¥ä¸ç‰ˆ
          - é•œåƒç‰ˆæœ¬: ${{ env.VERSION }}
          - å†…æ ¸ç‰ˆæœ¬: ${{ env.K_VER_FULL }}
          
          ## UTM è®¾ç½®æŒ‡å¼•
          1. é©±åŠ¨å™¨æ¥å£: VirtIO
          2. å†…æ ¸é•œåƒ: vmlinuz-standard
          3. Initrd é•œåƒ: initrd-standard
          4. å¯åŠ¨å‚æ•°: "root=/dev/vda rw console=tty0 console=ttyAMA0 rootwait"
          EOF

          tar -cvf - "$PKG_DIR" | xz -z -T0 -v > "${PKG_DIR}.tar.xz"
          echo "FINAL_PKG_NAME=${PKG_DIR}.tar.xz" >> $GITHUB_ENV

      - name: å‘å¸ƒè‡³ Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: fnnas_utm
          name: fnnas_utm_${{ env.VERSION }}
          body: |
            ### é£ç‰› OS UTM é€‚é…é•œåƒ (æ ‡å‡†å†…æ ¸åŒæ­¥ç‰ˆ)
            - é•œåƒç‰ˆæœ¬: ${{ env.VERSION }}
            - å†…æ ¸ç‰ˆæœ¬: ${{ env.K_VER_FULL }}
            - çŠ¶æ€: å·²å®Œæˆé©±åŠ¨åŒ¹é…ï¼ŒNFS åŠŸèƒ½æ­£å¸¸ã€‚
          files: ${{ env.FINAL_PKG_NAME }}
          overwrite_files: true
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
